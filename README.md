# SensorTagFirmwareCustom firmware images for the CC2650 based [TI SensorTag](http://www.ti.com/ww/en/wireless_connectivity/sensortag2015/)# SensorTagSuper.hexThe current SensorTagSuper.hex image is a customization of the SensorTag project found in the [TI BLE-STACK-2-1-1](http://www.ti.com/tool/ble-stack) that always advertises when not connected, and does so at a rate of 1s rather than the default of 100ms.It is a SuperHex File as described in:[CC2650 SensorTag User's Guide#Building_the_SensorTag_Firmware](http://processors.wiki.ti.com/index.php/CC2650_SensorTag_User's_Guide#Building_the_SensorTag_Firmware)# RHIoTTagSuper.hexThe RHIoTTagSuper.hex image is a customization of the SensorTag project and the [CC2640_SimpleEddystoneBeacon](https://github.com/TI-LPRF-Software/CC2640_SimpleEddystoneBeacon) project that advertises an extended version of the Eddystone TLM packet to include the key press state as well as the raw lux light sensor reading. It identifies itself as a 'CC2650 RHIoTTag' in its SCAN_RSP data as show in this hcidump result:	> HCI Event: LE Meta Event (0x3e) plen 38    	LE Advertising Report      	SCAN_RSP - Scan Response (4)      	bdaddr 68:C9:0B:06:F3:0A (Public)      	Complete local name: 'CC2650 RHIoTTag'      	Unknown type 0x12 with 4 bytes data      	TX power level: 0      	RSSI: -42Typical hcidump  and hcidump -R outputs for the custom packet:	> HCI Event: LE Meta Event (0x3e) plen 40    	LE Advertising Report      	ADV_IND - Connectable undirected advertising (0)      	bdaddr B0:B4:48:D6:DA:85 (Public)      	Flags: 0x04      	Complete service classes: 0xfeaa      	Unknown type 0x16 with 19 bytes data      	RSSI: -48	> 04 3E 28 02 01 00 00 85 DA D6 48 B4 B0 1C 02 01 04 03 03 AA   	FE 14 16 AA FE 20 00 0C C9 19 C8 00 09 44 43 00 2E CA D4 00   	00 28 D2 The type 0x16 is a ServiceData type that encodes the following information into the 19 bytes:     uint8_t   frameType;      // TLM = 0x20     uint8_t   version;        // 0x00 for now     uint8_t   vBatt[2];       // Battery Voltage, 1mV/bit, Big Endian     uint8_t   temp[2];        // Temperature. Signed 8.8 fixed point     uint8_t   advCnt[4];      // Adv count since power-up/reboot     uint8_t   secCnt[4];      // Time since power-up/reboot in 0.1 second resolution     // Non-standard eddystone TLM data     uint8_t   keys;           //  Bit 0: left key (user button), Bit 1: right key (power button), Bit 2: reed relay     uint8_t   lux[2];         // raw optical sensor data, BEThere is JNI code that maps the generic BLE advertising packets into Java here: [BeaconScannerJNI](https://github.com/RHioTResearch/BeaconScannerJNI)There is a base Java project that exposes the data as iBeacon or a RHIoTTag here: [BaseBeaconScanner](https://github.com/RHioTResearch/BaseBeaconScanner)### Toggling power on the RHIoTTagThe key press logic on the RHIoTTag has been changed so that the power button/right key does not immediately switch power off when it is in advertising mode so that both keys can be used. To turn off the power of the RHIoTTag, hold the power/right key for more than 5 seconds but less that 10 seconds. You will hear a brief buzz when you release the power button after 5 seconds to indicate that it was successful. To turn the tag back on, hold the power/right key again for just over 5 seconds and it will buzz when released, and begin advertising again with the green led flashing.# Flashing the FirmwareTo flash the firmware, you need the $15 [cc-devpack-debug](http://www.ti.com/tool/cc-devpack-debug) and the free [SmartRF Flash Programmer v2](http://www.ti.com/tool/flash-programmer).# Restoring the factory firmware using SmartRF v2 Flash ProgrammerIf you find that you SensorTag is not advertising as expected after doing a firmware update, try to restore the factory image that comes with the BLE 2.1.1 stack uisng the SmartRF v2 Flash Programmer.## Step 1: Download and install the following software from TI* [TI BLE-STACK-2-1-1](http://www.ti.com/tool/ble-stack)* [SmartRF Flash Programmer v2](http://www.ti.com/tool/flash-programmer)You need a free myTI development account to be able to agree to the download terms.## Step 2: Connect the SensorTag to Windows using the CC-DebuggerConnect the CC-Debugger USB cable to the Windows host and verify it is seen by opening up the Windows Device Manager. You can do this by starting to type the phrase "device manager" in the windows search field. This should locate the Device Manager control panel item as shown here:![DeviceManager Menu](images/DeviceManagerSearch.png)Launch the Device Manager, and you should find the CC-Debugger showing up as and XDS110 device under the Ports and Texas Instruments Debug Probes sections:![CC-Debugger devices](images/DeviceManager.png)## Step 3: Launch the Flash Programmer 2Launch the SmartRF v2 flash programmer by clicking the Flash Programmer 2 link on the desktop, or by finding the Flash Programmer 2 entry under the Texas Instruments folder in the all apps section of the start menu. On startup it should scan for connected devices and find the SensorTag under the XDS110 entry as a CC2650 target as shown here:![SmartRF v2 flash programmer app](images/FlashProgrammer.png)If the scan fails, try unplugging the CC-Debugger from USB port, and then plug it back in.## Step 4: Select the image to flashUnder the Flash image(s) section, click the Single radio button, and then browse to locate the C:/ti/simplelink/ble_cc26xx_2_01_01_44627/Accessories/HexFiles/CC2640_SensorTag.hex image that was installed as part of the BLE 2.1.1 stack installation.Under the Actions section, click to Erase all unprotected pages, click to Program entire source file, and click to verify with CRC check.## Step 5: flash the imageClick the run button found under the Verify section to begin flashing the image to the SensorTag. The complete output in the Status window and app interface should look similar to the following if the flash was successful:	>Initiate access to target: XDS-L3002770.	>Reading file: C:/ti/simplelink/ble_cc26xx_2_01_01_44627/Accessories/HexFiles/CC2640_SensorTag.hex.	>Start flash erase ...	>Erase finished successfully.	>Start flash programming ...	>Programming finished successfully.	>Start flash verify ...	>Skip verification of unassigned page: 12.	>Skip verification of unassigned page: 13.	>Skip verification of unassigned page: 14.	>Skip verification of unassigned page: 15.	>Page: 0 verified OK.	>Page: 1 verified OK.	>Page: 2 verified OK.	>Page: 3 verified OK.	>Page: 4 verified OK.	>Page: 5 verified OK.	>Page: 6 verified OK.	>Page: 7 verified OK.	>Page: 8 verified OK.	>Page: 9 verified OK.	>Page: 10 verified OK.	>Page: 11 verified OK.	>Page: 16 verified OK.	>Page: 17 verified OK.	>Page: 18 verified OK.	>Page: 19 verified OK.	>Page: 20 verified OK.	>Page: 21 verified OK.	>Page: 22 verified OK.	>Page: 23 verified OK.	>Page: 24 verified OK.	>Page: 25 verified OK.	>Page: 26 verified OK.	>Page: 27 verified OK.	>Page: 28 verified OK.	>Page: 29 verified OK.	>Page: 30 verified OK.	>Page: 31 verified OK.	>Verification finished successfully.	>Reset target ...	>Reset of target successfull.![Success output](images/FlashProgrammerSuccess.png)At this point the SensorTag should have been reset and will start advertising for 30 seconds. If it does not, try detaching the debugger and hitting the power button on the SensorTag.